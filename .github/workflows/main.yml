name: MLOps CI/CD manifest
on:
  push:
    branches: ["main"]
jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      - name: Installer dépendances
        run: |
          pip install -U pip
          pip uninstall -y dvc pathspec
          pip install "pathspec==0.11.2"
          pip install dvc pandas numpy scikit-learn joblib
      - name: Afficher le DAG DVC
        run: dvc dag

      - name: Générer données brutes
        run: python src/generate_data.py

      - name: Exécuter pipeline ML via DVC
        run: dvc repro
      
      - name: Vérifier métriques (Quality Gate F1)
        run: |
          python - << 'EOF'
          import json
          with open("reports/metrics.json", "r") as f:
              metrics = json.load(f)
          f1 = float(metrics.get("f1", 0.0))
          if f1 < 0.70:
              raise SystemExit(f"F1={f1} trop faible")
          print(f"F1={f1} validé")
          EOF
