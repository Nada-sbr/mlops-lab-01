name: MLOps CI/CD manifest

on:
  push:
    branches: ["main"]
  pull_request:

jobs:
  ci:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ vars.PY_VERSION }}

      # 3Ô∏è‚É£ Cache pip pour acc√©l√©rer les installations
      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-${{ runner.os }}-${{ vars.PY_VERSION }}-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            pip-${{ runner.os }}-${{ vars.PY_VERSION }}-

      # 4Ô∏è‚É£ Installer les d√©pendances Python et DVC
      - name: Installer d√©pendances
        run: |
          pip install -U pip
          pip install dvc pandas numpy scikit-learn joblib

      # 5Ô∏è‚É£ Restaurer cache DVC (optionnel si cache DVC local)
      - name: Restaurer cache DVC
        uses: actions/cache@v4
        with:
          path: .dvc/cache
          key: dvc-${{ runner.os }}-${{ vars.PY_VERSION }}-${{ github.sha }}
          restore-keys: |
            dvc-${{ runner.os }}-${{ vars.PY_VERSION }}-

      # 6Ô∏è‚É£ R√©cup√©rer les donn√©es depuis DVC
      - name: R√©cup√©rer les donn√©es DVC
        run: dvc pull

      # 7Ô∏è‚É£ Afficher le DAG du pipeline
      - name: Afficher le DAG DVC
        run: dvc dag

      # 8Ô∏è‚É£ G√©n√©rer les donn√©es brutes (si n√©cessaire)
      - name: G√©n√©rer donn√©es brutes
        run: python src/generate_data.py

      # 9Ô∏è‚É£ Reproduire le pipeline ML
      - name: Ex√©cuter pipeline ML via DVC
        run: dvc repro

      # üîü V√©rification des m√©triques (Quality Gate F1)
      - name: V√©rifier m√©triques (Quality Gate F1)
        run: |
          python - << 'EOF'
          import json
          threshold = float("${{ vars.F1_GATE_THRESHOLD }}")
          with open("reports/metrics.json", "r", encoding="utf-8") as f:
              metrics = json.load(f)
          f1 = float(metrics.get("f1", 0.0))
          print(f"F1={f1} | seuil={threshold}")
          if f1 < threshold:
              raise SystemExit("Quality Gate √©chou√© : F1 insuffisante")
          print("Quality Gate valid√©")
          EOF

      # 1Ô∏è‚É£1Ô∏è‚É£ Upload des artefacts ML
      - name: Upload artefacts ML
        uses: actions/upload-artifact@v4
        with:
          name: ml-artifacts
          path: |
            models/
            registry/
            reports/

  cd:
    needs: ci
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      # 1Ô∏è‚É£ Checkout du code
      - uses: actions/checkout@v4

      # 2Ô∏è‚É£ T√©l√©charger les artefacts valid√©s
      - name: T√©l√©charger artefacts valid√©s
        uses: actions/download-artifact@v4
        with:
          name: ml-artifacts
          path: release_artifacts

      # 3Ô∏è‚É£ CD simul√© (d√©ploiement SSH)
      - name: CD simul√© (d√©ploiement SSH)
        run: |
          echo "=== Phase CD (simul√©e) ==="
          echo "ENV               : ${{ vars.APP_ENV }}"
          echo "F1 gate           : ${{ vars.F1_GATE_THRESHOLD }}"
          echo "Secret (demo)     : ${{ secrets.DEMO_SECRET }}"
          echo
          echo "Artefacts pr√™ts :"
          ls -R release_artifacts
          echo
          echo "Simulation SSH : ssh user@server 'deploy release_artifacts/'"
